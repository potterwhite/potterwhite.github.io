<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://potterwhite.github.io/en/blog/><link rel=alternate type=application/rss+xml href=https://potterwhite.github.io/en/blog/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Blog | </title><meta name=description content="This is the blog section. It has two categories: News and Releases.
Files in these directories will be listed in reverse chronological order."><meta property="og:url" content="https://potterwhite.github.io/en/blog/"><meta property="og:title" content="Blog"><meta property="og:description" content="This is the blog section. It has two categories: News and Releases.
Files in these directories will be listed in reverse chronological order."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Blog"><meta itemprop=description content="This is the blog section. It has two categories: News and Releases.
Files in these directories will be listed in reverse chronological order."><meta itemprop=datePublished content="2025-07-29T00:00:00+00:00"><meta itemprop=dateModified content="2025-07-29T00:00:00+00:00"><meta itemprop=wordCount content="23"><meta name=twitter:card content="summary"><meta name=twitter:title content="Blog"><meta name=twitter:description content="This is the blog section. It has two categories: News and Releases.
Files in these directories will be listed in reverse chronological order."><link rel=preload href=/scss/main.min.8d9fc392f483ddcfc12deab0c7339579a28bf9668f42018b93887d57cf8a63f4.css as=style integrity="sha256-jZ/DkvSD3c/BLeqwxzOVeaKL+WaPQgGLk4h9V8+KY/Q=" crossorigin=anonymous><link href=/scss/main.min.8d9fc392f483ddcfc12deab0c7339579a28bf9668f42018b93887d57cf8a63f4.css rel=stylesheet integrity="sha256-jZ/DkvSD3c/BLeqwxzOVeaKL+WaPQgGLk4h9V8+KY/Q=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en/><span class="navbar-brand__logo navbar-logo"><svg width="30" height="1" viewBox="0 0 100 100"><rect width="100%" height="100%" fill="none"/><text x="50%" y="50%" font-family="Times New Roman" font-weight="bold" font-size="80" text-anchor="middle" fill="#fff" dy=".35em">J</text></svg></span><span class=navbar-brand__name></span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/en/portfolio/><span>Portfolio</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/blog/>简体中文</a></li></ul></div></li><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)"><svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.892a010247747e74263a3ce7ad01ea10.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/blog/>Return to the regular view of this page</a>.</p></div><h1 class=title>Blog</h1><ul><li><a href=#pg-1f5e41c2a6e8da01fe68a0105f93761f>DevOps</a></li><ul><li><a href=#pg-623e7f449e7aabdc71b88b6a227f5349>NFS (Network File System)</a></li></ul><li><a href=#pg-dab315c357b662cfb6579928147c649b>Linux</a></li><ul><li><a href=#pg-3c26aa984b30a1889c260accbceee96f>GMAC Bring Up Work Flow</a></li><li><a href=#pg-7b330209886be5de1eac30147d864443>GMAC Bring-Up Debug Strategies</a></li></ul></ul><div class=content><p>This is the <strong>blog</strong> section. It has two categories: News and Releases.</p><p>Files in these directories will be listed in reverse chronological order.</p></div></div><div class=td-content><h1 id=pg-1f5e41c2a6e8da01fe68a0105f93761f>DevOps</h1><div class="td-byline mb-4"><time datetime=2025-07-29 class=text-body-secondary>Jul 29, 2025</time></div></div><div class=td-content><h1 id=pg-623e7f449e7aabdc71b88b6a227f5349>NFS (Network File System)</h1><div class="td-byline mb-4"><time datetime=2025-07-29 class=text-body-secondary>Jul 29, 2025</time></div><h1 id=an-in-depth-retrospective-on-nfs-mounting-issues--establishing-a-standard-workflow>An In-Depth Retrospective on NFS Mounting Issues & Establishing a Standard Workflow</h1><h2 id=foreword>Foreword</h2><p>This document aims to provide a retrospective on the troubleshooting process for a persistent <code>Connection refused</code> error encountered when mounting an Ubuntu NFS server (<code>Anastasia-Ubuntu</code>) from an embedded BusyBox system (<code>david</code> host). The issue was ultimately resolved by adding the <code>-o nolock</code> mount option. This article will analyze the root cause of the failure in detail and establish a standard workflow for configuring NFS servers and clients, providing a reliable reference for future deployments.</p><hr><h2 id=part-1-deep-dive-into-the-connection-refused-issue>Part 1: Deep Dive into the &ldquo;Connection refused&rdquo; Issue</h2><h3 id=11-problem-description>1.1 Problem Description</h3><p>When attempting to mount a shared directory from an NFS server (<code>192.168.3.164</code>) on an embedded client (<code>david</code>) using standard commands, the operation consistently failed with a <code>Connection refused</code> error, even after multiple syntax corrections.</p><p><strong>Key Log of the Failure:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>root@david:/mnt<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># mount -t nfs 192.168.3.164:/mnt/nfs/rv1126 /mnt/nfs</span>
</span></span><span style=display:flex><span>mount: mounting 192.168.3.164:/mnt/nfs/rv1126 on /mnt/nfs failed: Connection refused
</span></span></code></pre></div><p>However, upon adding the <code>-o nolock</code> option, the mount operation succeeded immediately.</p><p><strong>Log of the Successful Mount:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>root@david:/mnt<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># mount -t nfs 192.168.3.164:/mnt/nfs/rv1126 -o nolock /mnt/nfs</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>root@david:/mnt<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># df -h</span>
</span></span><span style=display:flex><span>Filesystem                Size      Used Available Use% Mounted on
</span></span><span style=display:flex><span>/dev/root                 2.9G    751.8M      2.1G  26% /
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>192.168.3.164:/mnt/nfs/rv1126
</span></span><span style=display:flex><span>                        453.2G    236.4G    193.8G  55% /mnt/nfs
</span></span></code></pre></div><h3 id=12-the-troubleshooting-journey-ruling-out-the-usual-suspects>1.2 The Troubleshooting Journey: Ruling Out the Usual Suspects</h3><p>Before identifying <code>-o nolock</code> as the solution, we conducted an exhaustive investigation, systematically eliminating all common causes of NFS failures.</p><ul><li><strong>NFS Service on the Server</strong>: By running <code>rpcinfo -p localhost</code> on the server, we confirmed that NFS v3, NFS v4, and the <code>mountd</code> service were all running correctly and listening on the network ports.
<strong>Key Log Evidence</strong>:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>james@Anastasia-Ubuntu:~$ rpcinfo -p localhost
</span></span><span style=display:flex><span>   program vers proto   port  service
</span></span><span style=display:flex><span>   ...
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>100005</span>    <span style=color:#0000cf;font-weight:700>3</span>   tcp  <span style=color:#0000cf;font-weight:700>13025</span>  mountd
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>100003</span>    <span style=color:#0000cf;font-weight:700>3</span>   tcp   <span style=color:#0000cf;font-weight:700>2049</span>  nfs
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>100003</span>    <span style=color:#0000cf;font-weight:700>4</span>   tcp   <span style=color:#0000cf;font-weight:700>2049</span>  nfs
</span></span><span style=display:flex><span>   ...
</span></span></code></pre></div></li><li><strong>Server Firewall</strong>: The <code>sudo ufw status</code> command confirmed the firewall was <code>inactive</code>, meaning no network traffic was being blocked.</li><li><strong>Server Export Configuration (<code>/etc/exports</code>)</strong>: We verified that the shared directory was correctly exported to all clients (<code>*</code>) and that the <code>insecure</code> option was added for compatibility with embedded devices.</li><li><strong>Client Kernel Support</strong>: By running <code>cat /proc/filesystems</code> on the client, we confirmed that the kernel was compiled with <code>nfs</code> filesystem support.
<strong>Key Log Evidence</strong>:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>root@david:/root<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># cat /proc/filesystems</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>nodev   nfs
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li><li><strong>Client Functionality Integrity</strong>: A decisive clue was that the &ldquo;client <code>david</code> could successfully mount NFS shares from other PCs,&rdquo; proving that the client&rsquo;s own NFS functionality was not at fault.</li></ul><p>All standard checks indicated a &ldquo;perfectly normal&rdquo; setup, yet the problem persisted. This forced us to shift our focus to the deeper, more subtle details of the NFS protocol.</p><h3 id=13-root-cause-analysis-why--o-nolock-is-the-key>1.3 Root Cause Analysis: Why <code>-o nolock</code> is the Key?</h3><p><strong>The root cause was a communication failure between the client and server regarding the &ldquo;file locking&rdquo; feature.</strong></p><ol><li><p><strong>File Locking Mechanism</strong>:
To ensure data consistency when multiple clients access the same file, the NFS protocol implements a file locking mechanism. This mechanism relies on a separate protocol known as <strong>NLM (Network Lock Manager)</strong>. A standard NFS mount process involves not only establishing a data transfer channel but also requires the client to perform a &ldquo;handshake&rdquo; with the server&rsquo;s lock manager service (<code>nlockmgr</code>) to handle future file lock requests.</p></li><li><p><strong>Client&rsquo;s Missing Functionality</strong>:
Our client, <code>david</code>, is a highly stripped-down BusyBox system. To minimize its footprint, its NFS client implementation likely includes <strong>only the core data read/write functionality, while the complete NLM file locking client module has been omitted</strong>.</p></li><li><p><strong>The Failed &ldquo;Handshake&rdquo;</strong>:
When <code>david</code> attempted to mount, it followed the standard procedure. After the data channel was established, it tried to communicate with the server&rsquo;s <code>nlockmgr</code> service. However, due to its incomplete functionality, the request it sent was likely malformed or unrecognizable to the server. The server&rsquo;s RPC system, upon receiving this invalid request, could not process it and therefore <strong>actively refused the connection (<code>Connection refused</code>)</strong>, causing the entire mount operation to fail.</p></li><li><p><strong>The Role of <code>-o nolock</code></strong>:
This option is an instruction to the client&rsquo;s kernel: &ldquo;<strong>For this mount, completely disable the NLM file locking protocol.</strong>&rdquo; Upon receiving this directive, the kernel <strong>skips</strong> the step of communicating with the server&rsquo;s <code>nlockmgr</code> service. Because this guaranteed-to-fail step was bypassed, the rest of the mount process completed smoothly, resulting in a successful mount.</p></li></ol><p><strong>Conclusion</strong>: The <code>Connection refused</code> error did not stem from a network or permission issue, but rather from the stripped-down embedded client&rsquo;s inability to complete the &ldquo;file lock negotiation&rdquo; step of the standard NFS mount procedure, leading to rejection by the fully-featured server. The <code>-o nolock</code> option is the key to resolving such mount failures caused by incomplete client functionality.</p><hr><h2 id=part-2-a-standard-workflow-for-nfs-setup>Part 2: A Standard Workflow for NFS Setup</h2><p>The following workflow is designed to provide a reliable and reproducible process for setting up an NFS environment, with special considerations for using embedded devices as clients.</p><h3 id=21-server-side-configuration---ubuntudebian-example>2.1 Server-Side Configuration - Ubuntu/Debian Example</h3><h4 id=step-1-install-nfs-services>Step 1: Install NFS Services</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install nfs-kernel-server
</span></span></code></pre></div><h4 id=step-2-create-and-prepare-the-shared-directory>Step 2: Create and Prepare the Shared Directory</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example: Create a shared directory named nfs_share</span>
</span></span><span style=display:flex><span>sudo mkdir -p /mnt/nfs_share
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Assign permissive ownership to ensure client access</span>
</span></span><span style=display:flex><span>sudo chown nobody:nogroup /mnt/nfs_share
</span></span><span style=display:flex><span>sudo chmod <span style=color:#0000cf;font-weight:700>777</span> /mnt/nfs_share
</span></span></code></pre></div><h4 id=step-3-configure-the-exports-file-etcexports-core-step>Step 3: Configure the Exports File <code>/etc/exports</code> (Core Step)</h4><p>Open <code>/etc/exports</code> with a text editor:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/exports
</span></span></code></pre></div><p>Add a line to define the sharing rule. The following is a recommended configuration that is highly compatible and suitable for development environments:</p><pre tabindex=0><code>/mnt/nfs_share   *(rw,sync,no_subtree_check,no_root_squash,insecure)
</code></pre><p><strong>Options Explained & Notes:</strong></p><ul><li><code>/mnt/nfs_share</code>: The <strong>absolute path</strong> of the directory to be shared.</li><li><code>*</code>: Allows access from any IP address. For better security, this can be replaced with a specific subnet, e.g., <code>192.168.3.0/24</code>.</li><li><code>rw</code>: Allows read and write operations.</li><li><code>sync</code>: Writes data synchronously (as opposed to <code>async</code>), which is safer and less prone to data loss.</li><li><code>no_subtree_check</code>: Disables subtree checking, which can improve performance and reliability.</li><li><code>no_root_squash</code>: Allows the <code>root</code> user on the client to have <code>root</code> privileges on the mount point. <strong>This is crucial for embedded development and debugging.</strong></li><li><strong><code>insecure</code></strong>: <strong>[Note 1: Critical for Embedded Device Compatibility]</strong> Allows connections from clients using non-privileged ports (>1024). Many stripped-down embedded NFS clients cannot use privileged ports, and <strong>the absence of this option is a common cause of <code>Connection refused</code> errors.</strong></li></ul><h4 id=step-4-apply-the-configuration>Step 4: Apply the Configuration</h4><p>After every modification to <code>/etc/exports</code>, you must run this command to refresh the configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo exportfs -ra
</span></span></code></pre></div><p>To ensure all services are updated, you can also restart the NFS service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart nfs-kernel-server
</span></span></code></pre></div><h4 id=step-5-check-the-firewall-if-active>Step 5: Check the Firewall (If Active)</h4><p>If the server&rsquo;s firewall (<code>ufw</code>) is active, you need to add an inbound rule:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check status</span>
</span></span><span style=display:flex><span>sudo ufw status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Allow NFS connections from the entire local network (recommended)</span>
</span></span><span style=display:flex><span>sudo ufw allow from 192.168.3.0/24 to any port nfs
</span></span></code></pre></div><h3 id=22-client-side-configuration---using-the-embedded-david-as-an-example>2.2 Client-Side Configuration - Using the Embedded <code>david</code> as an Example</h3><h4 id=step-1-verify-basic-client-capabilities>Step 1: Verify Basic Client Capabilities</h4><p>Before mounting, perform a quick diagnosis to ensure prerequisites are met.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Check if the kernel supports NFS</span>
</span></span><span style=display:flex><span>cat /proc/filesystems <span style=color:#000;font-weight:700>|</span> grep nfs
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Expected output should include a line with &#34;nfs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Check network connectivity</span>
</span></span><span style=display:flex><span>ping &lt;server_ip_address&gt;
</span></span></code></pre></div><h4 id=step-2-create-a-local-mount-point>Step 2: Create a Local Mount Point</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /mnt/server_share
</span></span></code></pre></div><h4 id=step-3-execute-the-mount-command-core-step>Step 3: Execute the Mount Command (Core Step)</h4><p>Use the full command with compatibility options to perform the mount:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mount -t nfs -o <span style=color:#000>nfsvers</span><span style=color:#ce5c00;font-weight:700>=</span>3,nolock &lt;server_ip&gt;:&lt;absolute_path_on_server&gt; &lt;local_mount_point&gt;
</span></span></code></pre></div><p><strong>Specific Example:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mount -t nfs -o <span style=color:#000>nfsvers</span><span style=color:#ce5c00;font-weight:700>=</span>3,nolock 192.168.3.164:/mnt/nfs_share /mnt/server_share
</span></span></code></pre></div><p><strong>Options Explained & Notes:</strong></p><ul><li><code>-t nfs</code>: Explicitly specifies the filesystem type as NFS.</li><li><code>-o nfsvers=3</code>: <strong>[Note 2: Critical for Embedded Device Compatibility]</strong> Explicitly specifies the use of the NFSv3 protocol. Embedded clients may have incomplete support for the more complex NFSv4 protocol; forcing v3 can prevent many authentication and protocol negotiation issues.</li><li><code>-o nolock</code>: <strong>[Note 3: Critical for Embedded Device Compatibility]</strong> Disables the file locking (NLM) protocol. As demonstrated in this retrospective, stripped-down clients may lack NLM functionality, and <strong>this option is the ultimate solution for resolving <code>Connection refused</code> errors caused by a failed lock negotiation.</strong></li></ul><h4 id=step-4-verify-the-mount>Step 4: Verify the Mount</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Check the list of mounted filesystems</span>
</span></span><span style=display:flex><span>df -h
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># or</span>
</span></span><span style=display:flex><span>mount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Check if you can read/write files</span>
</span></span><span style=display:flex><span>ls /mnt/server_share
</span></span><span style=display:flex><span>touch /mnt/server_share/test_file_from_david
</span></span></code></pre></div><h4 id=step-5-configure-automatic-mounting-on-boot-optional>Step 5: Configure Automatic Mounting on Boot (Optional)</h4><p>To have the device mount the share automatically at boot, edit the <code>/etc/fstab</code> file.
<strong>Warning</strong>: On embedded systems, <code>/etc/fstab</code> may not exist or may be on a read-only partition. Proceed with caution.</p><pre tabindex=0><code># &lt;server_ip&gt;:&lt;share_path&gt;  &lt;local_mount_point&gt;  nfs  &lt;options&gt;  0  0
192.168.3.164:/mnt/nfs_share  /mnt/server_share  nfs  nfsvers=3,nolock,auto,bg  0  0
</code></pre><ul><li><code>auto</code>: Mount automatically at system startup.</li><li><code>bg</code>: If the initial mount fails (e.g., network not ready), retry in the background. This is very useful for embedded devices.</li></ul><hr><p><strong>END</strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-dab315c357b662cfb6579928147c649b>Linux</h1><div class="td-byline mb-4"><time datetime=2025-07-25 class=text-body-secondary>Jul 25, 2025</time></div></div><div class=td-content><h1 id=pg-3c26aa984b30a1889c260accbceee96f>GMAC Bring Up Work Flow</h1><div class="td-byline mb-4"><time datetime=2025-07-25 class=text-body-secondary>Jul 25, 2025</time></div><h2 id=1-identifying-the-gmac-from-the-schematic>1. Identifying the GMAC from the Schematic</h2><ul><li>From the default DTS provided by the SDK, it can be seen that there are two GMACs, gmac0 and gmac1.</li></ul><h3 id=11-first-check-the-schematic-from-the-hardware-engineer-search-for-gmac-and-see-if-gmac1-or-gmac0-is-used>1.1 First, check the schematic from the hardware engineer, search for GMAC, and see if gmac1 or gmac0 is used.</h3><p>To determine this, one must look at the pins used in the schematic and compare them with the configuration of the gmac nodes in the DTS.</p><p>The specific file is located at <code>kernel/arch/arm64/boot/dts/rockchip/rk3568-pinctrl.dtsi</code>.</p><p>During the BSP creation process (the previous step), a layered structure was established, and this dtsi file belongs to the lowest chip-level layer.
This file defines the specific sub-nodes of gmac1, and which pins correspond to each sub-node, for example:</p><p><img src=/2025/gmac-rk3568-bring-up/dts-gmac1m1_miim.png alt></p><p>When it comes to gmac1, it is further divided into m0 and m1. The image I have captured is the m1 portion. How do we know to use m1?
We can refer to the CPU section of the schematic:</p><p><img src=/2025/gmac-rk3568-bring-up/rk3568-gmac-pins-top-view.png alt></p><p>I have specifically captured the gmac module used this time. The hardware engineer has added &ldquo;M1&rdquo; after each pin name, which also reminds us that the one being used is GMAC1&rsquo;s M1.</p><h3 id=12-actually-why-can-the-hardware-side-correspond-to-the-dts>1.2 Actually, why can the hardware side correspond to the DTS?</h3><p>It is likely because when the hardware engineer was designing the schematic, they directly referenced the usage guidelines provided by the Chip Manufacturer. It&rsquo;s divided into GMAC1 and GMAC0, and GMAC1 is further divided into M0 and M1. I would guess that if we insisted on modifying it, using a hybrid version like a GMAC2 wouldn&rsquo;t be entirely impossible, but the DTS side would have to be completely redone. We would have to write out each pin one by one, just as it&rsquo;s done in <code>kernel/arch/arm64/boot/dts/rockchip/rk3568-pinctrl.dtsi</code>.</p><h3 id=13-to-summarize>1.3 To summarize:</h3><p>Looking at the symbols in the schematic is just a tip and not definitive.
The definitive way is to compare the pins configs in the chip-level dts include file. They must correspond.</p><h2 id=2-determining-the-clock-mode-from-the-schematic-and-the-flow-of-25m-and-125m-clocks>2. Determining the Clock Mode from the Schematic, and the flow of 25M and 125M clocks</h2><h3 id=21-first-look-at-the-phy-section-of-the-schematic><strong>2.1 First, look at the PHY section of the schematic</strong></h3><p><img src=/2025/gmac-rk3568-bring-up/yt8521sc-clock-related-three-pins.png alt></p><p>Here we can see that XTAL_I is grounded, and we don&rsquo;t yet know where XTAL_O and CLKOUT are connected.</p><h3 id=22-look-at-the-phy><strong>2.2 Look at the PHY&rsquo;s DataSheet</strong></h3><p><img src=/2025/gmac-rk3568-bring-up/yt8521sc-clock-pins-in-datasheet.png alt></p><h4 id=221-first-look-at-no44>2.2.1 First, look at No.44</h4><p>It is specifically written here that CLKOUT is an output type, and if it&rsquo;s not needed to output a clock to the MAC, this pin should be left floating.</p><p>However, it is not floating here, so the schematic must be outputting a 125MHz clock to the MAC.</p><h4 id=222-next-look-at-no45>2.2.2 Next, look at No.45</h4><p>It is introduced here that if XTAL_O is supplied with an external 25MHz clock, then XTAL_I must be grounded.
So, from the schematic showing XTAL_I is grounded, it should mean an external 25MHz is being supplied to the PHY.</p><p>Therefore, we just need to further trace which pins are actually connected.</p><h2 id=3-enter-the-dts-directory-find-the-entry-dts-disable-redundant-devices-and-enable-the-target-device>3. Enter the dts directory, find the entry dts, disable redundant devices, and enable the target device</h2><p>Because GMAC1M1 is used on my board, GMAC0 can be disabled.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>/*
</span></span><span style=display:flex><span>* 2nd: Configure the active GMAC0 interface.
</span></span><span style=display:flex><span>*
</span></span><span style=display:flex><span>* NOTE:   The properties below are overrides <span style=color:#204a87;font-weight:700>for</span> the <span style=color:#000;font-weight:700>&amp;</span>gmac0 node,
</span></span><span style=display:flex><span>*         which inherits its base configuration from <span style=color:#4e9a06>&#34;rk3568-evb1-ddr4-v10.dtsi&#34;</span>.
</span></span><span style=display:flex><span>*
</span></span><span style=display:flex><span>* ACTION: Review these settings against your schematic.
</span></span><span style=display:flex><span>*/
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&amp;</span>gmac0 <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>	// there is more ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	//status <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;okay&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&amp;</span>mdio0 <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>	// there is more ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>My initial judgment was not to use gmac0, so I did a lot of debugging, and only at the very end did I change them all to <code>status = "disabled"</code>;</p><h2 id=4-open-rockchip_developer_guide_linux_gmac_mode_configuration_cnpdf>4. Open Rockchip_Developer_Guide_Linux_GMAC_Mode_Configuration_CN.pdf</h2><p>Based on the determined clock mode, directly copy the node configuration. Do not modify other dtsi files (they are just libraries).</p><p>Open this manual provided by Rockchip:
<img src=/2025/gmac-rk3568-bring-up/mode-config-rk3568-part.png alt></p><p>There are so many modes here. SGMII, which stands for Serial Gigabit Media Independent Interface, is used for bridging, so SGMII and QSGMII are not within my scope of concern.</p><p>RMII Clock Input and Output also don&rsquo;t seem to apply to the current board&rsquo;s situation, because I have two clock speeds, 25MHz and 125MHz, so I&rsquo;ll look at the other four modes first.</p><p>Here, I referenced an article by an engineer named Baron:</p><p><img src=/2025/gmac-rk3568-bring-up/phy-clk-mode-from-baron.png alt></p><p><a href=https://baron-z.cn/2023/05/25/rk3566%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%B0%83%E8%AF%95/ target=_blank rel=noopener>Reference Link: A very good article</a></p><p>Following this summary, we should now choose <strong>RGMII PLL output 25M for PHY, RGMII_CLK input 125M for TX_CLK</strong>.</p><h2 id=5-summary>5. Summary</h2><ul><li><p>The above is just the normal porting process. During bring-up, it is very likely that the hardware is not okay. So, after confirming the correct porting process, you can confidently proceed to find bugs in the hardware.</p></li><li><p>Regarding the debugging mindset, my personal notes are organized here to provide a starting point for thinking: <a href=/en/blog/2025/07/25/gmac-bring-up-debug-strategies>GMAC Bring-Up Debug Strategies</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7b330209886be5de1eac30147d864443>GMAC Bring-Up Debug Strategies</h1><div class="td-byline mb-4"><time datetime=2025-07-25 class=text-body-secondary>Jul 25, 2025</time></div><p>The most important are these three parts, none can be missing.</p><h2 id=a-power><strong>a. Power</strong></h2><h3 id=schematic-diagram><strong>Schematic Diagram</strong></h3><p><img src=/2025/gmac-rk3568-bring-up/product-power-part-schema.png alt></p><h3 id=description><strong>Description</strong></h3><p>The power supply must be present first, and it must be normal.
The definition of &ldquo;normal&rdquo; is in the datasheet.
<img src=/2025/gmac-rk3568-bring-up/yt8521sc-datasheet-power-part.png alt></p><h3 id=category-1-avddl-and-dvddl><strong>Category 1: AVDDL and DVDDL</strong></h3><ul><li>Requires around 1.2V</li><li>The voltage requirement for R209 and R210 is around 1.2V</li></ul><h3 id=category-2-dvdd33-vdd33-and-avdd33><strong>Category 2: DVDD33, VDD33, and AVDD33</strong></h3><ul><li>Requires around 3.3V</li></ul><h3 id=category-3-><strong>Category 3: [Special][Caution] DVDD_RGMII</strong></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Digital RGMII I/O, MDC/MDIO power, adjusted by CFG_LDO<span style=color:#ce5c00;font-weight:700>[</span>1:0<span style=color:#ce5c00;font-weight:700>]</span>.
</span></span><span style=display:flex><span>	Note: When CFG_LDO<span style=color:#ce5c00;font-weight:700>[</span>1:0<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> 00, the I/O pad power is supplied from
</span></span><span style=display:flex><span>	the external 3.3V power connected to DVDD_RGMII pin. Otherwise,
</span></span><span style=display:flex><span>	it is supplied from the internal LDO.
</span></span></code></pre></div><ul><li>Test Method<ul><li>By testing pins 36 and 37 of the PHY
After testing, it was found that both are at a low level.</li><li>Testing R212
After testing with a multimeter, it was found that both ends are at 3.3V.</li></ul></li></ul><h2 id=b-crystal-clock><strong>b. Crystal (Clock)</strong></h2><h3 id=1-xtal_><strong>1. XTAL_I (Input pin related to the crystal)</strong></h3><ul><li>This pin is grounded, so there is nothing.</li><li>This is pin 47 of the PHY.</li></ul><h3 id=2-xtal_><strong>2. XTAL_O (Output pin related to the crystal)</strong></h3><ul><li>25MHz is measured from here.</li><li>How to test?<ul><li>Directly test pin 46 of the YT8521SC.</li></ul></li></ul><p>These two must come first, as they determine if the crystal is present.</p><p>Once that is confirmed, then look at MDIO. These two are related to the circuit that controls the PHY (YT8521SC) from the MAC (inside RK3568). One is the clock and the other is data. Both must be present.</p><h3 id=3-mdc-mdio-clock><strong>3. MDC (MDIO Clock)</strong></h3><ul><li><p>Test Method</p><ul><li>Directly test pin 14 of the PHY, there is no other way.</li></ul></li><li><p>Correct Result</p><ul><li>3.3V or close to it.</li></ul></li><li><p>Incorrect Result</p><ul><li>Significantly lower than 3.3V, for example, below 1V.</li></ul></li></ul><h3 id=4-mdio-mdio-data><strong>4. MDIO (MDIO Data)</strong></h3><ul><li><p>Test Method</p><ul><li>Test pin 15 of the PHY.</li></ul></li><li><p>Correct Result</p><ul><li>3.3V or close to it.</li></ul></li><li><p>Incorrect Result</p><ul><li>Significantly lower than 3.3V, for example, below 1V.</li></ul></li></ul><h2 id=c-reset><strong>c. Reset</strong></h2><ul><li><p>RESET_N (Reset pin)</p></li><li><p>In the DTS, it is:</p><ul><li>The <code>snps,reset-gpio</code> statement.</li></ul></li><li><p>Test Method</p><ul><li>One can test R205<ul><li><img src=/2025/gmac-rk3568-bring-up/yt8521sc-reset-resistor.png alt></li></ul></li><li>Or directly test pin 13 of the PHY<ul><li><img src=/2025/gmac-rk3568-bring-up/yt8521sc-reset-pin.png alt></li></ul></li></ul></li><li><p>Correct Result</p><ul><li>It pulls low once at power-on, then pulls high.<ul><li><img src=/2025/gmac-rk3568-bring-up/yt8521sc-reset-in-datasheet.png alt></li></ul></li></ul></li><li><p>Incorrect Result</p><ul><li>Does not pull low, or stays low continuously.</li></ul></li><li><p>It is very important to distinguish who provides the clock to whom, and who performs the frequency multiplication. Generally, there are two groups: who provides the original 25MHz, who does the frequency multiplication, and is it provided to anyone after multiplication?</p></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=X aria-label=X><a target=_blank rel=noopener href=https://x.com/potter_whi3340 aria-label=X><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Hugging Face" aria-label="Hugging Face"><a target=_blank rel=noopener href=https://huggingface.co/PotterWhite aria-label="Hugging Face"><i class="fab fa-robot"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/potterwhite aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://zadoktec.slack.com aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Potter White | <a href=https://creativecommons.org/licenses/by/4.0 target=_blank rel=noopener>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.c7cf76e0360e19b696291ec124be8f05e7d46230f8031e081350143806af8320.js integrity="sha256-x8924DYOGbaWKR7BJL6PBefUYjD4Ax4IE1AUOAavgyA=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>